<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title>회원 관리 시스템</title>
</head>
<body>
    <div layout:fragment="content">
        <h2>회원 관리</h2>
        
        <!-- 급하냥: 검색 폼 처리 -->
        <form th:action="@{/users/search}" method="get" style="margin-bottom: 20px;">
            <input type="text" name="keyword" th:value="${param.keyword}" 
                   placeholder="이름 또는 이메일로 검색">
            <button type="submit">검색</button>
        </form>
        
        <!-- 토심이: 조건부 메시지 표시 -->
        <div th:if="${not #lists.isEmpty(users)}" class="alert alert-info">
            총 [[${#lists.size(users)}]]명의 회원이 검색되었습니다.
        </div>
        <div th:unless="${not #lists.isEmpty(users)}" class="alert alert-warning">
            검색된 회원이 없습니다.
        </div>
        
        <!-- 토심이: 회원 목록 반복 출력 -->
        <table class="table" th:if="${not #lists.isEmpty(users)}">
            <thead>
                <tr>
                    <th>번호</th>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>등급</th>
                    <th>상태</th>
                    <th>가입일</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="user, userStat : ${users}" 
                    th:classappend="${userStat.even} ? 'even-row' : 'odd-row'">
                    <td th:text="${userStat.count}">1</td>
                    <td th:text="${user.name}">홍길동</td>
                    <td th:text="${user.email}">test@test.com</td>
                    <td>
                        <!-- 토심이: 등급별 표시 조건 분기 -->
                        <span th:switch="${user.grade}">
                            <span th:case="'VIP'" class="badge-vip">VIP</span>
                            <span th:case="'GOLD'" class="badge-gold">GOLD</span>
                            <span th:case="'SILVER'" class="badge-silver">SILVER</span>
                            <span th:case="*" class="badge-normal">일반</span>
                        </span>
                    </td>
                    <td>
                        <span th:if="${user.active}" class="status-active">활성</span>
                        <span th:unless="${user.active}" class="status-inactive">비활성</span>
                    </td>
                    <td th:text="${#temporals.format(user.createdDate, 'yyyy-MM-dd')}">2024-01-01</td>
                    <td>
                        <!-- 급하냥: 동적 링크 생성 -->
                        <a th:href="@{/users/{id}(id=${user.id})}" class="btn btn-info">상세</a>
                        <a th:href="@{/users/{id}/edit(id=${user.id})}" class="btn btn-warning">수정</a>
                        
                        <!-- 토심이: 관리자만 삭제 버튼 표시 -->
                        <a th:if="${#authorization.expression('hasRole(''ADMIN'')')}"
                           th:href="@{/users/{id}/delete(id=${user.id})}" 
                           class="btn btn-danger"
                           onclick="return confirm('정말 삭제하시겠습니까?')">삭제</a>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <!-- 바쁘개: 페이징 네비게이션 조각 삽입 -->
        <div th:replace="~{fragments/pagination :: navigation(${currentPage}, ${totalPages})}"></div>
    </div>
    
    <!-- 급하냥: 페이지별 JavaScript -->
    <th:block layout:fragment="extra-js">
        <script th:inline="javascript">
            // 토심이: 조건부 JavaScript 실행
            /*[+ if (${param.keyword != null}) { +]*/
                console.log('검색 키워드:', [[${param.keyword}]]);
                highlightSearchKeyword([[${param.keyword}]]);
            /*[+ } +]*/
            
            // 급하냥: 사용자 데이터를 JavaScript 변수로 전달
            var users = [[${users}]];
            console.log('로드된 사용자 수:', users.length);
        </script>
    </th:block>
</body>
</html>